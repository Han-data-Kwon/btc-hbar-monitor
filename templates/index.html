<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê³ ë˜ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 20px; }
        .tabs button { margin-right: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }
        .tabcontent { display: none; margin-top: 20px; }
        .active { border: 2px solid black; font-weight: bold; }
        .price-card {
            border: 1px solid #ccc; border-radius: 10px; padding: 15px; width: 220px;
            display: inline-block; margin: 10px; vertical-align: top;
        }
        .coin-img { max-width: 100px; max-height: 60px; margin-bottom: 5px; }
        .news-img { max-width: 100%; max-height: 180px; }
        .dark-mode { background-color: #222; color: #f0f0f0; }
    </style>
</head>
<body>

    <h1>ğŸ³ ê³ ë˜ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</h1>

    <div class="tabs">
        <button onclick="openTab('price')" id="defaultTab">ğŸ’° ì‹œì„¸</button>
        <button onclick="openTab('news')">ğŸ“° ë‰´ìŠ¤</button>
        <button onclick="openTab('economic')">ğŸ“Š ê²½ì œì§€í‘œ</button>
        <button onclick="openTab('whales')">ğŸ‹ ê³ ë˜ ê±°ë˜</button>
        <button style="float:right;" onclick="toggleDarkMode()">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
    </div>

    <!-- ì‹œì„¸ íƒ­ -->
    <div id="price" class="tabcontent">
        <h2>ğŸ’° ì‹¤ì‹œê°„ ì‹œì„¸ & <strong>RSI</strong></h2>
        <div id="priceCards"></div>
        <canvas id="rsiChart" height="100"></canvas>
    </div>

    <!-- ë‰´ìŠ¤ íƒ­ -->
    <div id="news" class="tabcontent">
        <h2>ğŸ“° ì½”ì¸ ë‰´ìŠ¤ ìš”ì•½</h2>
        <div id="newsContainer"></div>
    </div>

    <!-- ê²½ì œì§€í‘œ íƒ­ -->
    <div id="economic" class="tabcontent">
        <h2>ğŸ“Š ì£¼ìš” ê²½ì œì§€í‘œ</h2>
        <div id="economicsContainer"></div>
    </div>

    <!-- ê³ ë˜ ê±°ë˜ íƒ­ -->
    <div id="whales" class="tabcontent">
        <h2>ğŸ‹ ê³ ë˜ ê±°ë˜</h2>
        <div id="whaleContainer">
            <h3>BTC ê±°ë˜</h3>
            <table border="1" id="btcTable"></table>
            <h3>HBAR ê±°ë˜</h3>
            <table border="1" id="hbarTable"></table>
        </div>
    </div>

    <script>
        function openTab(tabName) {
            $('.tabcontent').hide();
            $('#' + tabName).show();
            $('.tabs button').removeClass("active");
            $(`.tabs button:contains(${tabName === 'price' ? 'ì‹œì„¸' : tabName === 'news' ? 'ë‰´ìŠ¤' : tabName === 'economic' ? 'ê²½ì œì§€í‘œ' : 'ê³ ë˜'})`).addClass("active");
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
        }

        async function fetchPrice() {
            const res = await fetch("/api/price");
            const data = await res.json();
            const container = $("#priceCards").empty();
            for (const [coin, v] of Object.entries(data)) {
                const trendIcon = v.change > 0 ? "ğŸ“ˆ" : "ğŸ“‰";
                container.append(`
                    <div class="price-card">
                        <h3>${coin}</h3>
                        <p style="color:green;">ğŸ’² ${v.price} USD</p>
                        <p>${trendIcon} ë³€í™”ìœ¨: ${v.change}%</p>
                    </div>
                `);
            }
        }

        async function fetchRSIChart() {
            const res = await fetch("/api/rsi");
            const data = await res.json();
            const labels = ["1", "2", "3", "4", "5"];
            const ctx = document.getElementById("rsiChart").getContext("2d");

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: Object.entries(data).map(([coin, values]) => ({
                        label: coin,
                        data: values,
                        fill: false,
                        tension: 0.3,
                        borderWidth: 2,
                    }))
                },
                options: {
                    responsive: true,
                    plugins: {
                        datalabels: {
                            color: 'black',
                            anchor: 'end',
                            align: 'top',
                            formatter: v => v,
                            font: { weight: 'bold' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        async function fetchNews() {
            const res = await fetch("/api/news");
            const data = await res.json();
            const container = $("#newsContainer").empty();
            data.forEach(article => {
                container.append(`
                    <div style="margin-bottom:20px;">
                        ${article.image ? `<img src="${article.image}" class="news-img">` : ""}
                        <h4><a href="${article.link}" target="_blank">${article.title}</a></h4>
                        <p>${article.date}</p>
                        <p>${article.summary}</p>
                    </div>
                `);
            });
        }

        async function fetchEconomics() {
            const res = await fetch("/api/economics");
            const data = await res.json();
            const container = $("#economicsContainer").empty();
            if (data.message) {
                container.append(`<p>${data.message}</p>`);
            } else {
                let table = "<table border='1'><tr><th>ë‚ ì§œ</th><th>ì§€í‘œëª…</th><th>êµ­ê°€</th><th>ì´ì „</th><th>ì˜ˆì¸¡</th><th>ì‹¤ì œ</th><th>í•´ì„</th></tr>";
                data.forEach(d => {
                    table += `<tr>
                        <td>${d.date}</td>
                        <td>${d.event}</td>
                        <td>${d.country}</td>
                        <td>${d.previous}</td>
                        <td>${d.forecast}</td>
                        <td>${d.actual}</td>
                        <td>${d.effect}</td>
                    </tr>`;
                });
                table += "</table>";
                container.append(table);
            }
        }

        async function fetchWhales() {
            const btc = await fetch("/api/btc_trades").then(r => r.json());
            const hbar = await fetch("/api/hbar_trades").then(r => r.json());

            const renderTable = (data) => {
                let html = `<tr><th>ì‹œê°„</th><th>ë³´ë‚¸ ì£¼ì†Œ</th><th>ë°›ëŠ” ì£¼ì†Œ</th><th>ìˆ˜ëŸ‰</th><th>ìœ í˜•</th><th>ë°©í–¥</th></tr>`;
                data.forEach(d => {
                    const dirColor = d.direction === "ë§¤ìˆ˜" ? "red" : "blue";
                    html += `<tr>
                        <td>${d.time}</td>
                        <td>${d.from}</td>
                        <td>${d.to}</td>
                        <td>${d.amount}</td>
                        <td>${d.type}</td>
                        <td style="color:${dirColor}; font-weight:bold;">${d.direction}</td>
                    </tr>`;
                });
                return html;
            };

            $("#btcTable").html(renderTable(btc));
            $("#hbarTable").html(renderTable(hbar));
        }

        function refresh() {
            fetchPrice();
            fetchRSIChart();
            fetchWhales();
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("defaultTab").click();
            fetchPrice();
            fetchRSIChart();
            fetchNews();
            fetchEconomics();
            fetchWhales();
            setInterval(() => {
                if ($("#price").is(":visible") || $("#whales").is(":visible")) {
                    refresh();
                }
            }, 30000); // 30ì´ˆ ê°„ê²©
        });
    </script>

</body>
</html>