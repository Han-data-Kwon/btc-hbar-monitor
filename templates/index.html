<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>고래 모니터링 대시보드</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; padding: 20px; }
        .tabs button { margin-right: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }
        .tabcontent { display: none; margin-top: 20px; }
        .active { border: 2px solid black; font-weight: bold; }
        .price-card {
            border: 1px solid #ccc; border-radius: 10px; padding: 15px; width: 220px;
            display: inline-block; margin: 10px; vertical-align: top;
        }
        .coin-img { max-width: 100px; max-height: 60px; margin-bottom: 5px; }
        .news-img { max-width: 100%; max-height: 180px; }
        .dark-mode { background-color: #222; color: #f0f0f0; }
    </style>
</head>
<body>

    <h1>🐳 고래 모니터링 대시보드</h1>

    <div class="tabs">
        <button onclick="openTab('price')" id="defaultTab">💰 시세</button>
        <button onclick="openTab('news')">📰 뉴스</button>
        <button onclick="openTab('economic')">📊 경제지표</button>
        <button onclick="openTab('whales')">🐋 고래 거래</button>
        <button style="float:right;" onclick="toggleDarkMode()">🌙 다크모드</button>
    </div>

    <!-- 시세 탭 -->
    <div id="price" class="tabcontent">
        <h2>💰 실시간 시세 & <strong>RSI</strong></h2>
        <div id="priceCards"></div>
        <canvas id="rsiChart" height="100"></canvas>
    </div>

    <!-- 뉴스 탭 -->
    <div id="news" class="tabcontent">
        <h2>📰 코인 뉴스 요약</h2>
        <div id="newsContainer"></div>
    </div>

    <!-- 경제지표 탭 -->
    <div id="economic" class="tabcontent">
        <h2>📊 주요 경제지표</h2>
        <div id="economicsContainer"></div>
    </div>

    <!-- 고래 거래 탭 -->
    <div id="whales" class="tabcontent">
        <h2>🐋 고래 거래</h2>
        <div id="whaleContainer">
            <h3>BTC 거래</h3>
            <table border="1" id="btcTable"></table>
            <h3>HBAR 거래</h3>
            <table border="1" id="hbarTable"></table>
        </div>
    </div>

    <script>
        function openTab(tabName) {
            $('.tabcontent').hide();
            $('#' + tabName).show();
            $('.tabs button').removeClass("active");
            $(`.tabs button:contains(${tabName === 'price' ? '시세' : tabName === 'news' ? '뉴스' : tabName === 'economic' ? '경제지표' : '고래'})`).addClass("active");
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
        }

        async function fetchPrice() {
            const res = await fetch("/api/price");
            const data = await res.json();
            const container = $("#priceCards").empty();
            for (const [coin, v] of Object.entries(data)) {
                const trendIcon = v.change > 0 ? "📈" : "📉";
                container.append(`
                    <div class="price-card">
                        <h3>${coin}</h3>
                        <p style="color:green;">💲 ${v.price} USD</p>
                        <p>${trendIcon} 변화율: ${v.change}%</p>
                    </div>
                `);
            }
        }

        async function fetchRSIChart() {
            const res = await fetch("/api/rsi");
            const data = await res.json();
            const labels = ["1", "2", "3", "4", "5"];
            const ctx = document.getElementById("rsiChart").getContext("2d");

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: Object.entries(data).map(([coin, values]) => ({
                        label: coin,
                        data: values,
                        fill: false,
                        tension: 0.3,
                        borderWidth: 2,
                    }))
                },
                options: {
                    responsive: true,
                    plugins: {
                        datalabels: {
                            color: 'black',
                            anchor: 'end',
                            align: 'top',
                            formatter: v => v,
                            font: { weight: 'bold' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        async function fetchNews() {
            const res = await fetch("/api/news");
            const data = await res.json();
            const container = $("#newsContainer").empty();
            data.forEach(article => {
                container.append(`
                    <div style="margin-bottom:20px;">
                        ${article.image ? `<img src="${article.image}" class="news-img">` : ""}
                        <h4><a href="${article.link}" target="_blank">${article.title}</a></h4>
                        <p>${article.date}</p>
                        <p>${article.summary}</p>
                    </div>
                `);
            });
        }

        async function fetchEconomics() {
            const res = await fetch("/api/economics");
            const data = await res.json();
            const container = $("#economicsContainer").empty();
            if (data.message) {
                container.append(`<p>${data.message}</p>`);
            } else {
                let table = "<table border='1'><tr><th>날짜</th><th>지표명</th><th>국가</th><th>이전</th><th>예측</th><th>실제</th><th>해석</th></tr>";
                data.forEach(d => {
                    table += `<tr>
                        <td>${d.date}</td>
                        <td>${d.event}</td>
                        <td>${d.country}</td>
                        <td>${d.previous}</td>
                        <td>${d.forecast}</td>
                        <td>${d.actual}</td>
                        <td>${d.effect}</td>
                    </tr>`;
                });
                table += "</table>";
                container.append(table);
            }
        }

        async function fetchWhales() {
            const btc = await fetch("/api/btc_trades").then(r => r.json());
            const hbar = await fetch("/api/hbar_trades").then(r => r.json());

            const renderTable = (data) => {
                let html = `<tr><th>시간</th><th>보낸 주소</th><th>받는 주소</th><th>수량</th><th>유형</th><th>방향</th></tr>`;
                data.forEach(d => {
                    const dirColor = d.direction === "매수" ? "red" : "blue";
                    html += `<tr>
                        <td>${d.time}</td>
                        <td>${d.from}</td>
                        <td>${d.to}</td>
                        <td>${d.amount}</td>
                        <td>${d.type}</td>
                        <td style="color:${dirColor}; font-weight:bold;">${d.direction}</td>
                    </tr>`;
                });
                return html;
            };

            $("#btcTable").html(renderTable(btc));
            $("#hbarTable").html(renderTable(hbar));
        }

        function refresh() {
            fetchPrice();
            fetchRSIChart();
            fetchWhales();
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("defaultTab").click();
            fetchPrice();
            fetchRSIChart();
            fetchNews();
            fetchEconomics();
            fetchWhales();
            setInterval(() => {
                if ($("#price").is(":visible") || $("#whales").is(":visible")) {
                    refresh();
                }
            }, 30000); // 30초 간격
        });
    </script>

</body>
</html>