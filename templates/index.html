<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>📈 고래 거래 & 주요 정보 대시보드</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Arial';
      margin: 0;
      padding: 20px;
      background-color: #fff;
      color: #000;
      transition: background 0.3s, color 0.3s;
    }
    .dark-mode {
      background-color: #1c1c1c;
      color: #f0f0f0;
    }
    .tab-btns button {
      margin-right: 10px;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
    }
    .tab-content { display: none; margin-top: 20px; }
    .tab-content.active { display: block; }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .card {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      transition: background 0.3s;
    }
    .dark-mode .card {
      background: #2e2e2e;
      border-color: #555;
    }
    canvas.sparkline { height: 40px !important; }

    .rsi { font-weight: bold; }
    .high { color: red; }
    .low { color: blue; }
    .neutral { color: gray; }

    table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 6px; text-align: center; }
    th { background-color: #eee; }
    .dark-mode th { background-color: #444; }
    a { text-decoration: none; color: #0645AD; }

    #toggleMode { position: fixed; top: 15px; right: 15px; padding: 6px 12px; }
  </style>
</head>
<body>

  <!-- 테마 전환 -->
  <button id="toggleMode">🌙 다크모드</button>

  <!-- 탭 버튼 -->
  <div class="tab-btns">
    <button onclick="switchTab('indicators')">📊 코인 지표</button>
    <button onclick="switchTab('news')">📰 뉴스</button>
    <button onclick="switchTab('econ')">📅 경제지표</button>
  </div>

  <!-- 탭 1: 지표 -->
  <div id="indicators" class="tab-content active">
    <h2>📊 주요 코인 지표</h2>
    <div class="grid" id="indicatorCards"></div>
  </div>

  <!-- 탭 2: 뉴스 -->
  <div id="news" class="tab-content">
    <h2>📰 Cointelegraph 뉴스</h2>
    <div id="newsList"></div>
  </div>

  <!-- 탭 3: 경제지표 -->
  <div id="econ" class="tab-content">
    <h2>📅 중요 경제 지표</h2>
    <table>
      <thead>
        <tr><th>지표명</th><th>국가</th><th>실제</th><th>예상</th><th>이전</th><th>날짜</th></tr>
      </thead>
      <tbody id="econTable"></tbody>
    </table>
  </div>

  <script>
    // 탭 전환
    function switchTab(id) {
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // 다크모드 토글
    document.getElementById("toggleMode").onclick = () => {
      document.body.classList.toggle("dark-mode");
    };

    // 지표 표시
    async function loadIndicators() {
      const res = await fetch("/api/indicators");
      const data = await res.json();
      const wrap = document.getElementById("indicatorCards");

      wrap.innerHTML = "";
      for (const [coin, d] of Object.entries(data)) {
        const canvasId = `spark-${coin}`;
        let rsiColor = d.rsi >= 70 ? "high" : d.rsi <= 30 ? "low" : "neutral";

        wrap.innerHTML += `
          <div class="card">
            <h3>${coin}</h3>
            <p>가격: $${d.price.toLocaleString()}</p>
            <p>24H: ${d.change >= 0 ? '+' : ''}${d.change}%</p>
            <p class="rsi ${rsiColor}">RSI: ${d.rsi}</p>
            <canvas class="sparkline" id="${canvasId}"></canvas>
          </div>
        `;

        setTimeout(() => {
          new Chart(document.getElementById(canvasId).getContext("2d"), {
            type: 'line',
            data: {
              labels: d.spark.map((_, i) => i),
              datasets: [{
                data: d.spark,
                borderWidth: 1,
                pointRadius: 0,
                fill: false,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: { x: { display: false }, y: { display: false } }
            }
          });
        }, 100);
      }
    }

    async function loadNews() {
      const res = await fetch("/api/news");
      const data = await res.json();
      const wrap = document.getElementById("newsList");
      wrap.innerHTML = data.map(n => `
        <div class="card" style="margin-bottom:10px">
          <a href="${n.link}" target="_blank"><strong>${n.title}</strong></a><br/>
          <small>발행일: ${n.published}</small>
        </div>
      `).join("");
    }

    async function loadEcon() {
      const res = await fetch("/api/econ");
      const data = await res.json();
      const wrap = document.getElementById("econTable");
      wrap.innerHTML = data.map(d => `
        <tr>
          <td>${d.name}</td><td>${d.country}</td><td>${d.actual}</td>
          <td>${d.forecast}</td><td>${d.previous}</td><td>${d.date}</td>
        </tr>
      `).join("");
    }

    function loadAll() {
      loadIndicators(); loadNews(); loadEcon();
    }

    loadAll();
    setInterval(loadAll, 30000);
  </script>
</body>
</html>