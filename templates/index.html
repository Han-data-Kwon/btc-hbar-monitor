<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ˆ ì‹¤ì‹œê°„ ê³ ë˜ ê±°ë˜ëŸ‰ (30ì´ˆ ë‹¨ìœ„ / í•œêµ­ì‹œê°„)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>ğŸŸ  ë¹„íŠ¸ì½”ì¸ ê³ ë˜ ê±°ë˜ëŸ‰ (ìµœê·¼ 30ë¶„)</h2>
  <h3 id="btcPrice">BTC ì‹œì„¸ ë¡œë”©ì¤‘...</h3>
  <canvas id="btcChart" width="800" height="300"></canvas>

  <h2>ğŸ”µ í—¤ë°ë¼ ê³ ë˜ ê±°ë˜ëŸ‰ (ìµœê·¼ 30ë¶„)</h2>
  <h3 id="hbarPrice">HBAR ì‹œì„¸ ë¡œë”©ì¤‘...</h3>
  <canvas id="hbarChart" width="800" height="300"></canvas>

  <script>
    async function updatePrice() {
      const res = await fetch("/api/price");
      const data = await res.json();

      const btc = data.BTC;
      const hbar = data.HBAR;

      document.getElementById("btcPrice").innerText =
        `BTC: $${btc.price.toLocaleString()} (${btc.change >= 0 ? "+" : ""}${btc.change}%)`;

      document.getElementById("hbarPrice").innerText =
        `HBAR: $${hbar.price.toFixed(4)} (${hbar.change >= 0 ? "+" : ""}${hbar.change}%)`;
    }

    const btcCtx = document.getElementById('btcChart').getContext('2d');
    const hbarCtx = document.getElementById('hbarChart').getContext('2d');

    const createChart = (ctx, label) => new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          { label: '0â€“1 ë‹¨ìœ„', data: [], borderWidth: 2 },
          { label: '1â€“10 ë‹¨ìœ„', data: [], borderWidth: 2 },
          { label: '10â€“100 ë‹¨ìœ„', data: [], borderWidth: 2 },
          { label: '100+ ë‹¨ìœ„', data: [], borderWidth: 2 }
        ]
      },
      options: {
        responsive: true,
        animation: false,
        scales: {
          x: {
            title: { display: true, text: 'ì‹œê°„ (KST)' }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: 'ê±°ë˜ ìˆ˜ëŸ‰' }
          }
        },
        plugins: {
          tooltip: { enabled: true },
          legend: { position: 'top' }
        }
      }
    });

    const btcChart = createChart(btcCtx, 'BTC');
    const hbarChart = createChart(hbarCtx, 'HBAR');

    const updateChart = async (url, chart) => {
      const res = await fetch(url);
      const data = await res.json();
      chart.data.labels = data.map(d => d.time);
      chart.data.datasets[0].data = data.map(d => d.data["0-1"].count);  // ê±´ìˆ˜ ê¸°ë°˜
      chart.data.datasets[1].data = data.map(d => d.data["1-10"].count);
      chart.data.datasets[2].data = data.map(d => d.data["10-100"].count);
      chart.data.datasets[3].data = data.map(d => d.data["100+"].count);
      chart.update();
    };

    const updateCharts = () => {
      updateChart("/api/btc", btcChart);
      updateChart("/api/hbar", hbarChart);
    };

    updateCharts();
    updatePrice();
    setInterval(updateCharts, 30000);   // 30ì´ˆë§ˆë‹¤ ê°±ì‹ 
    setInterval(updatePrice, 30000);    // 30ì´ˆë§ˆë‹¤ ì‹œì„¸ ê°±ì‹ 
  </script>
</body>
</html>